{% extends 'base.html' %}
{% load static %}
{% block content %}
<h2>Batch Evaluations</h2>
<a id="top"></a>
<form id="batch-eval-form" method="post">
    {% csrf_token %}
    <div class="batch-eval-flex">
        <div class="batch-eval-col">
            <label for="exams" class="batch-eval-label">Select Exams:</label><br>
            <select name="exams[]" id="exams" multiple size="8" class="batch-eval-select">
                {% for subject, exams in subjects_with_exams.items %}
                  <optgroup label="{{ subject.name }}">
                    {% for exam in exams %}
                      <option value="{{ exam.id }}">{{ exam.description }}</option>
                    {% endfor %}
                  </optgroup>
                {% endfor %}
            </select>
        </div>
        <div class="batch-eval-col">
            <label for="models" class="batch-eval-label">Select Models:</label><br>
            <select name="models[]" id="models" multiple size="8" class="batch-eval-select">
                {% if local_models %}
                  <optgroup label="Local Models">
                    {% for model in local_models %}
                      <option value="{{ model.id }}">{{ model }}</option>
                    {% endfor %}
                  </optgroup>
                {% endif %}
                {% if external_models %}
                  <optgroup label="Remote Models">
                    {% for model in external_models %}
                      <option value="{{ model.id }}">{{ model }}</option>
                    {% endfor %}
                  </optgroup>
                {% endif %}
            </select>
        </div>
    </div>
    <div class="batch-eval-form-row">
        <label for="repetitions" class="batch-eval-label" style="margin-bottom:0;">Repetitions per eval:</label>
        <input type="number" name="repetitions" id="repetitions" min="1" value="1" required style="margin-bottom:0;">
        <button type="submit" class="batch-eval-btn">Launch Batch Evaluations</button>
        <div id="eval-count-indicator" class="batch-eval-count-indicator"></div>
    </div>
</form>

<!-- Progress and results UI -->
<div id="loading-indicator" class="batch-eval-loading-indicator">
    <div class="loading-spinner"></div>
    <p>Processing... ðŸ”„</p>
    <div class="batch-eval-progress-bar-container">
      <div id="progress-bar" class="batch-eval-progress-bar">
        0%
      </div>
    </div>
</div>
<div id="batch-eval-results"></div>
<div id="batch-eval-errors"></div>

<!-- Results Table -->
<table id="batch-eval-table" class="batch-eval-table" style="width:100%;margin-top:1em;display:none;">
  <thead>
    <tr>
      <th>Date</th>
      <th>Model</th>
      <th>Subject</th>
      <th>Exam</th>
      <th>Repetition</th>
      <th>Grade</th>
      <th>Time</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
<div id="exam-details"></div>
{% endblock %}

{% block extra_scripts %}
  <link rel="stylesheet" href="{% static 'css/batch_evaluations.css' %}">
  <script src="{% static 'js/evaluate_utils.js' %}"></script>
  <script src="{% static 'js/batch_evaluations.js' %}"></script>
{% endblock %}
